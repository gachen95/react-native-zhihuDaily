 ## 目录结构
```
├─assets 资源文件夹
│  ├─images  图像资源
│  └─video   视频文件
├─componetns  组件文件夹
│  ├─AvatarPicker  头像选择
│  ├─Bar   进度条
│  ├─CountDownButton  倒计时按钮
│  ├─ProgressBarModal  下载进度弹层
│  ├─PullUpLoading  下拉加载
│  ├─ScrollView    集成上拉刷新和下拉加载的ScrollView
│  └─StoriesList 公共日报列表
├─pages  页面文件夹
│  ├─Comment 评论页
│  ├─Details 详情页
│  ├─Drawer  侧边栏
│  ├─Home    首页
│  ├─ImgView 图像缩放下载
│  ├─Login    登录
│  ├─Registered 注册
│  ├─Section  栏目
│  └─Setting  设置
├─routers  路由文件夹
│ └─AppRouter.js APP主路由
├─store 状态管理仓库文件夹
│  ├─index.js 导出Store
│  └─ThemeStore.js 主题Store
├─theme  主题文件夹
│  ├─ blackTheme.js 夜间主题配色 
│  └─ defaultTheme.js 默认主题配色
├─utils 工具和配置文件夹
│  ├─ api.js  API配置文件
│  ├─ axios.js Axios配置文件
│  ├─ fontSize.js 字体缩放适配
│  ├─ index.js  统一导出各工具组件
│  ├─ storage.js  本地存储初始化配置文件
│  ├─ strageSync.js 本地存储同步远程数据函数
|  ├─ system.js   获取系统信息
|  └─ tools.js 工具函数 
|   
|_ App.js  应用根节点 

```
## 应用入口
        
   - App.js (应用根节点)
   - AppRouter.js (应用主导航)


 ### App.js
   >App.js是整个应用的根级组件 , 在这个组件中主要挂载了一些全局功能组件, 包括: 热更新 , 本地存储 , 极光推送等.
 ### AppRouter.js
   > AppRouter中结合react-navigation框架, 声明应用的路由导航信息 , 并导出到给App.js使用 . 其中路由导航是一个两级嵌套结构 , 外层为抽屉导航(DrawerNavigator) , 实现侧边栏抽屉与主页面的切换功能 . 主页面(Home)中嵌套一个堆栈导航(StackNavigator) , 用于实现页面之间的跳转功能 .
   

   需要注意的 , 在抽屉导航绑定焦点事件中 , 使用DeviceEventEmitter作为事件通知.  
   DeviceEventEmitter在用于解决跨页面之间事件通知时很方便 . 列如 我在A页面触发一个事件 , 希望B页面也能接收到时,就可以用到DeviceEventEmitter .

## 配置文件

### store 文件夹
    
  > App应用中使用 Mobx 作为状态管理工具 , Mobx个人感觉比Redux更简单一点 . 应用中仅主题切换功能使用了Mobx .
     
  - index.js 主要用于将多个Store库汇集成一个对象导出 , 因为项目中仅有一个Store , 也可以忽略掉.
  - ThemeStore.js 主题Store , 声明主题切换的action方法
   
  
  #### 扩展阅读
  1. [React小书](http://huziketang.mangojuice.top/books/react/lesson1)
  2. [慕课网Mobx入门视频教程](https://www.imooc.com/learn/1012)
  3. [Mobx中文网文档](https://cn.mobx.js.org/)
 
### utils 文件夹
  > utils中包含API , 本地存储配置文件 , 以及tools等工具函数 .  这里还封装了```Axios```用于替代```Fetch```做htttp数据请求 , 主要由于 Fetch 功能太少 , 请求超时都要自己实现.
 
  这里主要说明本地存储相关的storage.js 和 strageSync.js . storage.js是本地存储的配置文件 , 通过App.js导入项目中就可以全局使用. strageSync.js是用于配置同步远程数据 , 刷新本地存储数据的异步方法 , 其中```sync```对象下方法名与存储的key值是对应的关系. 更多内容可以查看[react-native-storage文档](https://github.com/sunnylqm/react-native-storage/blob/master/README.zh-CN.md)

### theme 文件夹
  > 包含默认和夜间的主题配色信息

##  全局组件

  ### AvatarPicker (头像选择组件)
  
  >结合 react-native-actionsheet 行动表组件  , react-native-image-picker 图像选择组件 ,  react-native-image-crop-picker 图像裁切组件 , 实现一个图像选择到裁切的用户头像选取组件. 
  
  ### Bar (进度条组件)
  
  > 实现动画进度条 ,  用于配合 ProgressBarModal(下载进度组件)

  ###  CountDownButton (倒计时按钮组件)

  >倒计时按钮封装 , 主要用于点击获取验证码时的倒计时按钮.

  ###  ProgressBarModal (下载进度条弹层)

  > 用于热更新时显示下载进度

  ###  PullUpLoading (下拉加载状态组件)

  > 用于下载刷新时 , 在列表底部显示"正在加载"或"没有更多了"等文字信息

  ###  ScrollView (滚动容器组件)
  
  >  此ScrollView中组件封装了上拉刷新和下拉触底的方法

  ###  StoriesList (日报列表组件)

  > 日报列表组件


 ##  页面功能实现  
    
  ### Home (首页)
   >Home是整个应用相对复杂的页面 , 从上到下可以分为三个部分 : 导航栏 , 轮播图 , 日报列表 . 这三个部分中还结合一些小功能 , 导致代码量较多 ,  这里分部分说明各功能的实现.

   -  导航栏  

      导航栏由react-navigation提供 , 这里没有选择手动实现 . 在navigationOptions属性中配置标题,背景色通过Mobx动态获取 . 并通过react-native-elements增加左右的按钮和图标 . 需要注意的 , navigationOptions中无法通过this访问组件内的状态和函数 , 列如: ```this.state.xxx```或者```this.xxx()``` 都是不行的, 只能 通过```this.props.navigation.setParams```传参的方式 ,  有时通过保存```this```引用为```that```也阔以解决.
   
   -  轮播图
      
      轮播图是相对独立的部分与其他组件没有太复杂的交互 , 这里我将其独立为单独的文件 . 主要通过react-native-swiper实现 , 结合react-native-linear-gradient实现背景渐变的效果 . 文字悬浮在背景层上这里是通过样式的绝对定位和zIndex实现的 , 在不使用样式时,通过```<ImageBackground>``` 组件应该也可以实现.
   
   -  日报列表
       
      日报列表是应用中复用较多的部分 , 这里将其抽离成组件 . 同时也将ScrollView抽离成组件 , 这样仅需要为日报列表绑定数据源和点击事件并为下拉和上拉加载绑定对应方法 , 而不必关注其内部实现 . 

   -  其他功能

      -  主题切换
         
         这里主要涉及Mobx的使用 ,  在组件头部顶部引入主题仓库 , @observer标记组件为可观察的 . 
         ```javascript
            @inject('theme')
            @observer
         ``` 
         在点击切换按钮时 , 触发theme中action行为事件即可实现切换主题效果.

      -  标题跟随滚动切换

         首先每天日报都有一个时间标题 , 需要实现当滚动到日报区域时 , 对应导航条标题切换到该日报的时间标题. 实现原理 : ```<View>```组件有一个```onLayout```方法 ,当```View```高度宽度发生变化时 可以触发并返回新的高宽度 . 通过记录高度区间为一个数组, 每次滚动时判断当前在哪个高度区间 , 既可得出当前日报区域的日期.
         
      -   日报数据缓存
          
            通过结合 react-native-storage 为日报列表增加缓存 , 当数据不过期时 , 优先调用缓存数据 . 这里需要注意 , 当数据过期时  react-native-storage 会返回过期的数据 , 然后再查找对应的```Sync``` 异步方法更新数据 , 但更新后并不会再次返回 , 下次调用时才返回新的数据. 这就导致有网络且数据过期时,react-native-storage 返回的是过期的数据 , 而不是最新的. 这里通过判断网络状态 , 当链接网络时 , 不调用缓存只等待最新数据返回 , 当离线状态下 , 调用缓存.

      -  其他
         
         包括日期选择 , 弹出层组件 , 只是一些组件的基本使用 , 不在赘述.
  
  ###   Details (详情页) 

  > 详情页主要涉及 WebView和动画的使用
    

  - 导航栏
     
      导航栏的分享 , 收藏 , 点赞功能中仅有分享是实际有效的 , 其他只有交互效果. 这里为收藏和点赞增加了交互动画 ,  主要涉及了react-native-animatable的基础使用 .

  - WebvView

      这里使用react-native-autoheight-webview替代自带的WebvView , 主要是想解决当WebvView嵌套在ScrollView下时 , 由于两者都存在滚动条 , 互相产生冲突 , WebView的高度会塌陷丢失. react-native-autoheight-webview可以解决这个问题.   
      这里还通过 customScript 注入JS到webview中 , 增加点击图片显示大图和处理WebView超链接点击的功能.
     
  - 滚动动画
   
      当页面下滑时存在导航条渐隐, 背景图缓慢上移 , 内容上移视差滚动动画.   

      > 开发历程 :

       最初我通过CSS绝对定位, 控制MarginTop,translateY属性切换来实现动画 , 但发现安卓快速滚动时存在性能问题 , 动画跟不上滚动速度. 安卓可以通过 ``` useNativeDriver: true ```原生本机驱动的形式优化动画性能 , 但该属性支持的动画属性十分有限 , 仅支持opacity, translate transform 下属性 , 不支持像MarginTop这种布局属性 , transform 也不像 Web端 CSS 支持修改动画基点 . 当时搞的头大 , 后来发现react-native-parallax-scroll-view 可以解决部分 , 它能解决页面布局的问题 , 不需要CSS绝对定位就可以实现类似布局, 我仅需要实现导航条渐隐背景图上移动画即可.

      > 代码说明 :
      
      - 导航条渐隐:  

        这里不仅实现了导航条滚动渐隐动画 , 还存下滑时隐藏导航条 ,上滑显示导航条的行为. 所以我这里记录背景图的高度 , 导航条的高度信息 . 通过判断滚动条Y轴坐标来实现不同效果 . 

      - 背景图上移

         背景图上移就比较简单了 , 控制图片容器的 translateY 属性就可以 , 只需要注意速度要慢于滚动条滚动速度 , 这样才阔以产生视差滚动的效果.
   
   -  其他
      
      -  大字体  
         
         通过控制 CSS 增加 ```<html>```标签字号百分比实现
      - WebView 夜间主题

         WebView引用的CSS文件中有关于夜间主题的样式 , 通过给```<body>```标签追加样式即可 .


  ### Comment (评论页)

   > 涉及<Modal>遮罩层  <FlatList> 二维列表

    主要就涉及  Modal遮罩层 和 二维数组列表 , 业务代码居多 .

  ###  Drawer (侧边栏抽屉)

   > 涉及登录状态读取 , 头像选取拍摄 

   

   - 登录身份验证流程

          登录流程在应用中并没有线上功能 , 只是一个流程模拟 .
   
   关于登录验证 在react-navigation的[文档](https://reactnavigation.org/docs/zh-Hans/auth-flow.html)中已提供示例 , 示例中的关键点在于通过 createSwitchNavigator 创建导航 . 但SwitchNavigator导航并不适用本应用 , 问题点在于SwitchNavigator没有提供切换过渡动画 , 影响使用体验 . 本应用中将登录相关的页面 , 注册在 堆栈导航器中(StackNavigator) , 登录成功后通过跳转的方式返回首页.  开发中发现 , 由于首页已存在导航栈中 , 登录成功跳转回首页并不会重新触发侧边栏(Drawer)的componentDidMount生命周期行为 , 导致侧边栏(Drawer)无法重新获取本地存储中的登录状态 . react-navigation 也没有提供回调方法 判断侧边栏的打开状态 , 最终通过在 App.js注册自定义事件 , 在侧边栏中监听全局自定义事件才解决这个问题.

  
   -  头像选取

      头像选取功能使用的是封装好的组件 , 方法很简单  , 不在赘述 .

      补充说明 : 最初实现拍照功能时 ,使用过react-native-camera , 用起来才发现它是需要自行实现相机UI界面的 , 如果没用这方面需求 最好别用它...



   



   


      

 
      







